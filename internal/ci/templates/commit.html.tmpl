<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{.ShortSHA}} - Prompt Story</title>
  <style>{{.CSS}}</style>
</head>
<body>
  <nav class="nav">
    <a href="index.html">&larr; Back to PR overview</a>
  </nav>

  <div class="header">
    <h1><code>{{.ShortSHA}}</code></h1>
    <p class="meta">{{.Subject}}</p>
  </div>

  <div class="filter-controls">
    <label class="toggle-label">
      <input type="checkbox" id="toggle-all-entries" class="toggle-input" checked>
      <span class="toggle-switch"></span>
      <span>Show all entries</span>
    </label>
    <label class="toggle-label">
      <input type="checkbox" id="toggle-whole-session" class="toggle-input">
      <span class="toggle-switch"></span>
      <span>Show whole session</span>
    </label>
    <label class="toggle-label">
      <input type="checkbox" id="toggle-agent-sessions" class="toggle-input" checked>
      <span class="toggle-switch"></span>
      <span>Show agent sessions</span>
    </label>
  </div>

  <div class="stats">
    <div class="stat">
      <div class="stat-value">{{len .Sessions}}</div>
      <div class="stat-label">Sessions</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="visible-count">{{.PromptCount}}</div>
      <div class="stat-label">Entries</div>
    </div>
  </div>

  <div class="commit-meta" style="margin-bottom: 24px;">
    <strong>Full SHA:</strong> <code>{{.SHA}}</code><br>
    <strong>Work period:</strong> {{formatTime .StartWork}} - {{formatTime .EndWork}}
  </div>

  {{range $i, $sess := .Sessions}}
  <div class="commit-card{{if .IsAgent}} agent-session{{end}}" data-is-agent="{{.IsAgent}}">
    <div class="commit-header">
      <h3>
        {{if .IsAgent}}<span class="badge agent">Agent</span>{{else}}<span class="badge main">Main</span>{{end}}
        Session {{add $i 1}}: {{formatToolName .Tool}}
      </h3>
      <div class="commit-meta">
        <code class="session-id">{{.ID}}</code> |
        {{formatTime .Start}} - {{formatTime .End}} | <span class="session-count">{{len .Prompts}}</span> entries
      </div>
    </div>
    <div class="session">
      <ul class="prompt-list">
        {{range .Prompts}}
        <li class="prompt-item {{.Type}}{{if not .InWorkPeriod}} outside-work-period{{end}}"
            data-entry-type="{{entryCategory .Type}}"
            data-in-work-period="{{.InWorkPeriod}}">
          <span class="prompt-time">{{formatTimeShort .Time}}</span>
          <span class="prompt-type">{{.Type}}</span>
          {{if eq .Type "TOOL_USE"}}
          <span class="tool-name">{{.ToolName}}</span>
          {{if or .ToolInput .ToolOutput}}
          <details class="tool-details" open>
            <summary>Hide details</summary>
            {{if .ToolInput}}
            <div class="tool-section-label">Input</div>
            <div class="tool-input">{{.ToolInput}}</div>
            {{end}}
            {{if .ToolOutput}}
            <div class="tool-section-label">Output</div>
            <div class="tool-output">{{truncate .ToolOutput 2000}}</div>
            {{end}}
          </details>
          {{end}}
          {{else if eq .Type "DECISION"}}
          <span class="decision-header">({{.DecisionHeader}})</span>
          <span class="prompt-text">{{.Text}}</span>
          <span class="decision-answer">â†’ {{.DecisionAnswer}}</span>
          {{else}}
          <span class="prompt-text{{if .Truncated}} truncated{{end}}">{{.Text}}</span>
          {{end}}
        </li>
        {{end}}
      </ul>
    </div>
  </div>
  {{end}}

  <div class="footer">
    Generated by <a href="https://github.com/QuesmaOrg/git-prompt-story">git-prompt-story</a>
  </div>

  <script>
  (function() {
    const toggleAllEntries = document.getElementById('toggle-all-entries');
    const toggleWholeSession = document.getElementById('toggle-whole-session');
    const toggleAgentSessions = document.getElementById('toggle-agent-sessions');
    const visibleCount = document.getElementById('visible-count');

    function updateFilters() {
      const showAll = toggleAllEntries.checked;
      const wholeSession = toggleWholeSession.checked;
      const showAgents = toggleAgentSessions.checked;
      let count = 0;

      // First, handle agent session visibility
      document.querySelectorAll('.commit-card').forEach(card => {
        const isAgent = card.dataset.isAgent === 'true';
        if (isAgent && !showAgents) {
          card.classList.add('hidden');
        } else {
          card.classList.remove('hidden');
        }
      });

      // Then handle individual entry visibility
      document.querySelectorAll('.prompt-item').forEach(el => {
        const card = el.closest('.commit-card');
        if (card && card.classList.contains('hidden')) {
          el.classList.add('hidden');
          return;
        }

        const isUser = el.dataset.entryType === 'user';
        const inWorkPeriod = el.dataset.inWorkPeriod === 'true';

        const showByType = showAll || isUser;
        const showByTime = wholeSession || inWorkPeriod;

        if (showByType && showByTime) {
          el.classList.remove('hidden');
          count++;
        } else {
          el.classList.add('hidden');
        }
      });

      visibleCount.textContent = count;

      // Update session counts
      document.querySelectorAll('.commit-card:not(.hidden)').forEach(card => {
        const visible = card.querySelectorAll('.prompt-item:not(.hidden)').length;
        const countEl = card.querySelector('.session-count');
        if (countEl) countEl.textContent = visible;
      });
    }

    toggleAllEntries.addEventListener('change', updateFilters);
    toggleWholeSession.addEventListener('change', updateFilters);
    toggleAgentSessions.addEventListener('change', updateFilters);

    // Initial update
    updateFilters();
  })();
  </script>
</body>
</html>
